<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>おまかせモード</title>
    <base target="_blank">
    <link rel="shortcut icon" href="../tools/favicon.ico">
    <link rel="stylesheet" type="text/css" href="../tools/almond.lite.css">
    <link rel="stylesheet" type="text/css" href="../tools/additional.css">
</head>

<body>
    <!-- ============================== -->
    <div class="container">

        <h2>おまかせモード</h2>

        <div class="ui">
            <textarea class="inputLines" placeholder="paste here!"></textarea>
            <input type="button" value="整形" id="exeButton">
        </div>

        <ul>
            <li>下図のように<code>項目</code>と<code>ノンブル</code>の2列を Excel から貼り付けてください。</li>
            <li>自動で一連の整形を行って索引を出力します。</li>
            <li>先に子項目を作成していると正しく名寄せやソートが行われません。</li>
        </ul>

        <div class="status"></div>

        <div class="result-markup limit-height">
            <table>
                <thead>
                    <tr>
                        <th>項目</th>
                        <th>読み</th>
                        <th>配列読み</th>
                    </tr>
                </thead>
                <tbody><td></td><td></td><td></td></tbody>
            </table>
        </div>
        <input type="button" value="表をコピー" id="copyButton">


        <img src="./image/img_auto.png">

        <ul>
            <li><code>項目</code>列を Word に貼り付ければ索引になります。</li>
            <li><code>読み</code>と<code>配列読み</code>の列は並びのチェックのためにご利用ください。</li>
            <li>下記のチェックツールもご利用ください。
                <ul>
                    <li><a href="../tools/CheckReference/index.html">見よ項目のチェック</a></li>
                    <li><a href="../tools/CheckChild/index.html">子項目のチェック</a></li>
                    <li><a href="../tools/CheckNombre/index.html">ノンブルの並びのチェック</a></li>
                </ul>
            </li>
        </ul>

    </div>
    <!-- ============================== -->
    <script type="text/javascript" src="../tools/GetReading/kuromoji.js" defer></script>
    <script type="module">
        import {Util, Entry, setNavi} from "../tools/common.js";
        setNavi();

        import {Reading} from "../tools/GetReading/src.js";
        import {NormalizedReading} from "../tools/Hairetsu/src.js";
        import {Grouper} from "../tools/Group/src.js";
        import {Sorter} from "../tools/Sort/src.js";

        function showStatus(s) {
            const elem = document.querySelector(".status");
            elem.innerHTML = s;
        }

        function main(tokenizer, selector, outputSelector) {
            showStatus("");

            const grouper = new Grouper(selector, false);
            const sorter = new Sorter();

            new Reading(tokenizer).parseLines(grouper.getGroupedLines()).forEach(parsed => {
                const r = new Entry(parsed.reading).name;
                sorter.addData(
                    parsed.item,
                    r,
                    NormalizedReading.convert(r, true)
                );
            });
            document.querySelector(outputSelector).innerHTML = sorter.execute().map(x => {
                return `<tr><td><mark>${x.item}</mark></td><td>${x.reading}</td><td>${x.normalized}</td></tr>`;
            }).join("\n");

        }

        document.querySelector("#exeButton").addEventListener("click", () => {
            showStatus("（\u{1f914}よみがな計算中…）");
            document.querySelector(".result-markup tbody").innerHTML = "";
            kuromoji.builder({ dicPath: "../tools/GetReading/dict" }).build((err, tokenizer) => {
                if (err) {
                    showStatus("解析失敗…\nやり直してみてください！");
                }
                else {
                    main(tokenizer, ".ui .inputLines", ".result-markup tbody");
                }
            });
        });

        document.querySelector("#copyButton").addEventListener("click", () => {
            Util.copyTable(".result-markup tbody");
        });

    </script>
</body>

</html>