<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>索引再利用</title>
    <base target="_blank">
    <link rel="shortcut icon" href="../../assets/favicon.ico">
    <link rel="stylesheet" type="text/css" href="../../assets/almond.lite.css">
    <link rel="stylesheet" type="text/css" href="../../assets/additional.css">
</head>

<body>
    <div class="container">

        <h1>索引再利用</h1>
        <!-- ///////////////////////////////////////////////////////////////

            体裁調整

        /////////////////////////////////////////////////////////////// -->
        <section>
            <h2>旧版索引の体裁調整</h2>
            <div id="preformat">
                <div class="ui">
                    <textarea placeholder="paste here!" v-model="content"></textarea>
                    <button @click="format">実行</button>
                </div>
                <ul>
                    <li><strong>長い行が折り返されて改行になっている箇所</strong>、<strong>項目とノンブル間が2倍アキになっていない箇所</strong>は先に手動で整形してください。</li>
                    <li>見よ項目の矢印の前のアキを1倍モノに統一します。</li>
                    <li>連続するノンブルを示すダーシの種類を統一します。</li>
                    <li>子項目のダーシの種類を統一します。</li>
                </ul>
                <div class="ui">
                    <textarea placeholder="result" readonly v-model="formatted"></textarea>
                    <copy-button :copy-func="copy" :copied="copied"></copy-button>
                </div>
                <div class="result-markup">
                    <div v-if="modified.length">
                        <h4>{{message}}</h4>
                        <ol><li v-for="(fmt, idx) in modified" :key="idx">
                            <ul>
                                <li style="color: gray;">{{fmt.original}}</li>
                                <li style="color: red;">{{fmt.formatted}}</li>
                            </ul>
                        </li></ol>
                    </div>
                    <div v-else>{{message}}</div>
                </div>
            </div>
        </section>
        <!-- ///////////////////////////////////////////////////////////////

            子項目復元

        /////////////////////////////////////////////////////////////// -->
        <section>
            <h2>子項目の復元</h2>
            <div id="completeChild">
                <div class="ui">
                    <textarea placeholder="paste here!" v-model="content"></textarea>
                    <button @click="format">実行</button>
                </div>
                <div class="ui">
                    <textarea placeholder="result" readonly v-model="formatted"></textarea>
                    <copy-button :copy-func="copy" :copied="copied"></copy-button>
                </div>
            </div>
            <img src="./image/img_complete.png">
        </section>
        <!-- ///////////////////////////////////////////////////////////////

            名開き

        /////////////////////////////////////////////////////////////// -->
        <section>
            <h2>名開き</h2>
            <div id="release">
                <div class="ui">
                    <textarea placeholder="paste here!" v-model="content"></textarea>
                    <button @click="release">実行</button>
                </div>
                <div v-if="released.length">
                    <div class="result-markup limit-height">
                        <table>
                            <thead>
                                <tr><th>項目</th><th>ノンブル</th></tr>
                            </thead>
                            <tbody>
                                <tr v-for="(item, idx) in released" :key="idx">
                                    <td>{{item.name}}</td>
                                    <td>{{item.nombre}}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <copy-button :copy-func="copy" :copied="copied"></copy-button>
                </div>
            </div>
            <img src="./image/img_releasegroup.png">
        </section>
    </div>
    <!-- ///////////////////////////////////////////////////////////////

        JavaScript

    /////////////////////////////////////////////////////////////// -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.37/dist/vue.global.js"></script>
    <script type="module">

        import {Util, Entry, AddressHandler} from "../../assets/common.js";

        import {IndexLine} from "./src/preformat/src.js";

        const copyButton = {
            props: {
                copyFunc: {
                    type: Function,
                    require: true
                },
                copied: {
                    type: Boolean,
                    require: true
                }
            },
            template: `
            <button @click="copyFunc" :class="{done:copied}">コピー</button>
            `
        };

        function formatOldIndex(lines) {
            return lines.map(line => String(line).trimEnd().replace(/\t/, "\u3000\u3000")).map(line => {
                const fmt = new IndexLine(line).getFormattedLine();
                return {
                    "formatted": fmt,
                    "original": line,
                };
            });
        }


        const vmPreformat = Vue.createApp({
            data: function () {
                return {
                    content: "",
                    fmtArr: [],
                    message: "",
                    copied: false,
                }
            },
            computed: {
                contentLines: function() {
                    return this.content.split(/\n/).map(line => String(line));
                },
                formatted: function() {
                    return this.fmtArr.map(x => x.formatted).join("\n");
                },
                modified: function() {
                    return this.fmtArr.filter(x => x.formatted != x.original);
                },
            },
            components: {
                "copy-button": copyButton
            },
            methods: {
                reset: function(){
                    this.fmtArr = [];
                    this.copied = false;
                },
                format: function() {
                    this.reset();
                    formatOldIndex(this.contentLines).forEach(x => {
                        this.fmtArr.push(x);
                    });
                    if (this.modified.length > 0) {
                        this.message = this.modified.length + "箇所を修正しました！";
                    }
                    else {
                        this.message = "問題のある箇所は見当たりませんでした！";
                    }
                },
                copy: function() {
                    Util.copyToClipboard(this.formatted);
                    this.copied = true;
                }
            }
        }).mount("#preformat");

        function completeChildEntry(lines) {
            const trimmedLines = lines.filter(x => String(x).trim());
            const stack = [];
            const parentStack = [];
            stack.push(trimmedLines[0]);
            parentStack.push(new Entry(trimmedLines[0]).basename);
            for (let i = 1; i < trimmedLines.length; i++) {
                const cur = String(trimmedLines[i]);
                if (cur.indexOf("\u2015\u2015") != -1) {
                    const completed = cur.trim().replace("\u2015\u2015", parentStack.at(-1));
                    stack.push(completed);
                }
                else {
                    stack.push(cur);
                    parentStack.push(new Entry(cur).basename);
                }
            }
            return stack;
        }

        const vmComplete = Vue.createApp({
            data: function () {
                return {
                    content: "",
                    fmtArr: [],
                    copied: false,
                }
            },
            computed: {
                contentLines: function() {
                    return this.content.split(/\n/).map(line => String(line));
                },
                formatted: function() {
                    return this.fmtArr.join("\n");
                },
            },
            components: {
                "copy-button": copyButton
            },
            methods: {
                reset: function(){
                    this.fmtArr = [];
                    this.copied = false;
                },
                format: function() {
                    this.reset();
                    completeChildEntry(this.contentLines).forEach(x => {
                        this.fmtArr.push(x);
                    });
                },
                copy: function() {
                    Util.copyToClipboard(this.formatted);
                    this.copied = true;
                }
            }
        }).mount("#completeChild");

        function releaseGrouping(lines) {
            const stack = [];
            lines.filter(line => line.trim()).map(line => line.replace("\t", "\u3000\u3000")).forEach(line => {
                    const entry = new Entry(line);
                    if (entry.isReference) {
                        stack.push({
                            "name": entry.name,
                            "nombre": ""
                        });
                    }
                    else {
                        new AddressHandler(entry.address).nombres.forEach(nombre => {
                            stack.push({
                                "name": entry.name,
                                "nombre": nombre.display.text
                            });
                        });
                    }
                });
            return stack;
        }

        const vmRelease = Vue.createApp({
            data: function () {
                return {
                    content: "",
                    released: [],
                    copied: false,
                }
            },
            computed: {
                contentLines: function() {
                    return this.content.split(/\n/).map(line => String(line));
                },
            },
            components: {
                "copy-button": copyButton
            },
            methods: {
                reset: function(){
                    this.released = [];
                    this.copied = false;
                },
                release: function(){
                    this.reset();
                    releaseGrouping(this.contentLines).forEach((x, i) => {
                        this.released.push(x);
                    });
                },
                copy: function() {
                    const joined = this.released.map(x => `${x.name}\t${x.nombre}`.trimEnd()).join("\n");
                    Util.copyToClipboard(joined);
                    this.copied = true;
                },
            }
        }).mount("#release");

    </script>
</body>

</html>