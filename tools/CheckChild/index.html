<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>子項目候補の確認</title>
    <base target="_blank">
    <link rel="shortcut icon" href="../favicon.ico">
    <link rel="stylesheet" type="text/css" href="../style.css">
    <style>
        .match {
            color: red;
        }
        .result {
            background: white;
        }
    </style>
</head>

<body>
<!-- ============================== -->
<div class="container">

<h2>子項目候補の確認</h2>
<div class="caption">
    <ul>
        <li>名寄せ済みの索引に対して子項目の候補を探します。</li>
    </ul>
</div>

<div class="ui">
    <form class="searchPos">
        <label><input type="radio" name="pos" value="tail" checked>末尾一致</label>
        <label><input type="radio" name="pos" value="head"        >先頭一致</label>
        <label><input type="radio" name="pos" value="all"         >両方</label>
    </form>
    <textarea class="inputLines" placeholder="名寄せした索引をコピー＆ペーストしてください"></textarea>
    <input type="button" value="チェック" onclick="click_check()">

    <table class="result">
        <tr>
            <td>項目</td>
            <td>子項目候補</td>
        </tr>
    </table>
    <input type="button" value="表をコピー" onclick="click_copy()">
</div>

</div>
<!-- ============================== -->
<script type="text/javascript" src="../util.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/ie-buster@1.1.0/dist/ie-buster.min.js"></script>
<script>

function getIndexItems(lines) {
    const nonMiyoItems = lines.filter(line => !line.match(/→/g));
    return nonMiyoItems.filter(line => line).filter(line => !line.match(/^　/g)).map(line => line.replace(/　　\d.*$/g, "")).sort((a, b) => b.length - a.length);
}

function getRegexpPattern(s, mode) {
    const escaped = escapeMeta(s);
    if (mode == "tail") {
        return new RegExp(`${escaped}$`, "g");
    }
    if (mode == "head") {
        return new RegExp(`^${escaped}`, "g");
    }
    return new RegExp(`^${escaped}|${escaped}$`, "g");
}

function findPossibleChildItems(lines, mode = "tail") {
    const indexItems = getIndexItems(lines);
    return indexItems.map(item => {
        const baseName = item.replace(/（.*?）|［.*?］/g, "");
        const reg = getRegexpPattern(baseName, mode);
        const grep = indexItems.filter(line => line.match(reg));
        if (grep.length > 1) {
            const markup = grep.filter(line => (line != item)).map(line => {
                return line.replace(reg, '<span class="match">$&</span>');
            }).map(line => `・${line}`);
            return {
                "Found": item,
                "Markup": markup.join("<br>")
            };
        }
        return null;
    }).filter(x => x);
}

function click_check() {
    const elem = document.querySelector(".ui");
    const lines = arrayByLine(elem.querySelector(".inputLines").value);
    const outputTable = elem.querySelector("table.result");
    resetTable(outputTable);
    const markup = findPossibleChildItems(lines, elem.querySelector("form.searchPos").pos.value);
    markup.forEach(r => {
        const row = outputTable.insertRow(-1);
        const cell1 = row.insertCell(0);
        const cell2 = row.insertCell(1);
        cell1.innerHTML = r.Found;
        cell2.innerHTML = r.Markup;
    });
}

function click_copy() {
    const table = document.querySelector("table.result");
    copyTable(table);
}

</script>
</body>

</html>
