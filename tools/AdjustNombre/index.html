<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>ノンブル加算減算</title>
    <base target="_blank">
    <link rel="shortcut icon" href="../favicon.ico">
    <link rel="stylesheet" type="text/css" href="../almond.lite.css">
    <link rel="stylesheet" type="text/css" href="../additional.css">
    <style>

        ul.config li input {
            max-width: 20%;
        }

    </style>
</head>

<body>
    <!-- ============================== -->
    <div class="container">

        <h1>ノンブル加算減算</h1>

        <div id="app">
            <ul class="config">
                <li>開始 <input type="number" min="1" v-model="start"></li>
                <li>終了 <input type="number" min="1" v-model="end"></li>
                <li>増分 <input type="number" v-model="delta"></li>
            </ul>

            <div class="ui">
                <textarea placeholder="paste here!" v-model="content"></textarea>
                <button @click="adjust">実行</button>
            </div>
            <div class="ui">
                <textarea placeholder="result" readonly v-model="adjusted"></textarea>
                <button @click="copy">コピー</button>
            </div>

            <div id="src-detail" class="result-markup">

                <div v-if="diffArr.length">
                    <h4>{{message}}</h4>
                    <ul>
                        <li v-for="(diff, idx) in diffArr" :key="idx">
                            <span>{{diff.name}}&#12288;&#12288;</span><span
                                v-for="(elem, idx) in diff.detail"
                                :key="idx"><span
                                    style="color:#bbb; text-decoration: line-through;">{{ elem.before }}</span><span
                                    :style="{color: elem.color}">{{ elem.text }}</span><span
                                        v-if="idx < diff.detail.length - 1">, </span>
                            </span>
                        </li>
                    </ul>
                </div>
                <div v-else>{{message}}</div>
            </div>
        </div>

    </div>
    <!-- ============================== -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script type="module">
        import {Util, Entry, EntryAddress, setNavi} from "../common.js";
        setNavi();

        class NombreAdjuster {
            constructor(start, end, delta) {
                this.start = start;
                this.end = end;
                this.delta = delta;
            }
            exec(target) {
                if (Number(this.start) <= target.intValue && target.intValue <= Number(this.end)) {
                    return (target.display.prefix + (target.intValue + Number(this.delta)) + target.display.suffix);
                }
                return target.display.text;
            }
        }

        class EntryLine {
            constructor(line, adjuster) {
                const entry = new Entry(line);
                this.name = entry.name;
                this.originalNombres = EntryAddress.sanitize(entry.address).split(",").map(x => x.trim()).filter(Boolean);
                this.adjustedNombres = this.originalNombres.map(nombre => {
                    const parsed = new EntryAddress(nombre).nombres;
                    if (parsed.length > 1) {
                        // 範囲指定のノンブルだった場合
                        return adjuster.exec(parsed[0]) + "\u2013" + adjuster.exec(parsed.at(-1));
                    }
                    return adjuster.exec(parsed[0]);
                });
            }

            compareAddress() {
                const stack = [];
                let modified = false;
                this.originalNombres.forEach((nombre, idx) => {
                    if (Util.stripNAN(nombre) != Util.stripNAN(this.adjustedNombres[idx])) {
                        modified = true;
                        stack.push({
                            "text": this.adjustedNombres[idx],
                            "before": nombre,
                            "color": "#ff0080"
                        });
                    }
                    else {
                        stack.push({
                            "text": nombre,
                            "before": "",
                            "color": "#333"
                        });
                    }
                });
                return {
                    "modified": modified,
                    "detail": stack
                };
            }

        }

        const vm = new Vue({
            el: "#app",
            data: {
                content: "",
                start: 1,
                end: 999,
                delta: 1,
                adjustedArr: [],
                diffArr: [],
                message: ""
            },
            computed: {
                contentLines: function() {
                    return this.content.split(/\n/).map(line => String(line));
                },
                adjusted: function() {
                    return this.adjustedArr.map(x => {
                        return `${x.name}\u3000\u3000${x.nombres.join(", ")}`.trimEnd();
                    }).join("\n");
                },
            },
            methods: {
                reset: function() {
                    this.message = "";
                    this.adjustedArr = [];
                    this.diffArr = [];
                },
                adjust: function() {
                    this.reset();
                    const adjuster = new NombreAdjuster(this.start, this.end, this.delta);
                    this.contentLines.forEach(line => {
                        const entryLine = new EntryLine(line, adjuster);
                        this.adjustedArr.push({
                            "name": entryLine.name,
                            "nombres": entryLine.adjustedNombres
                        });
                        const comparison = entryLine.compareAddress();
                        if (comparison.modified) {
                            this.diffArr.push({
                                "name": entryLine.name,
                                "detail": comparison.detail
                            });
                        }
                    });
                    if (this.diffArr.length) {
                        this.message = this.diffArr.length + "件の変更があります。"
                    }
                    else {
                        this.message = "修正箇所はありません。";
                    }
                },
                copy: function() {
                    Util.copyToClipboard(this.adjusted);
                }
            }
        });

    </script>
</body>

</html>