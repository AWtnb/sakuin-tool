<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>ノンブル加算減算</title>
    <base target="_blank">
    <link rel="shortcut icon" href="../favicon.ico">
    <link rel="stylesheet" type="text/css" href="../almond.lite.css">
    <link rel="stylesheet" type="text/css" href="../additional.css">
    <style>

        ul.config li input {
            max-width: 20%;
        }

    </style>
</head>

<body>
    <!-- ============================== -->
    <div class="container">

        <h1>ノンブル加算減算</h1>

        <ul class="config">
            <li>
                開始
                <input type="number" value="1" min="1" class="startNombre">
            </li>
            <li>
                終了
                <input type="number" value="999" min="1" class="endNombre">
            </li>
            <li>
                増分
                <input type="number" value="1" class="nombreDelta">
            </li>
        </ul>

        <div class="ui">
            <textarea id="scrollA" class="inputLines" placeholder="paste here!"></textarea>
            <input type="button" value="計算" id="exeButton">
        </div>

        <div class="ui">
            <textarea id="scrollB" class="result" placeholder="結果が表示されます" readonly></textarea>
            <input type="button" value="コピー" id="copyButton">
        </div>

        <ul>
            <li>名寄せされた索引に対して、指定範囲でノンブルを増やしたり減らしたりします。</li>
            <li>ノンブル間のカンマは必ず半角になります。</li>
        </ul>
        <input type="button" value="チェックリストを印刷" id="printButton">
        <div id="src-detail" class="result-markup"></div>

    </div>
    <!-- ============================== -->
    <script type="module">
        import {Util, Entry, EntryAddress, setScroller, setNavi} from "../common.js";
        setScroller();
        setNavi();

        class NombreAdjuster {
            constructor(start, end, delta) {
                this.start = start;
                this.end = end;
                this.delta = delta;
            }
            exec(target) {
                if (Number(this.start) <= target.intValue && target.intValue <= Number(this.end)) {
                    return (target.display.prefix + (target.intValue + Number(this.delta)) + target.display.suffix);
                }
                return target.display.text;
            }
        }

        class EntryLine {
            constructor(line, adjuster) {
                this.entry = new Entry(line);
                this.originalNombres = EntryAddress.sanitize(this.entry.address).split(",").map(x => x.trim()).filter(Boolean);
                this.adjustedNombres = this.originalNombres.map(nombre => {
                    const parsed = new EntryAddress(nombre).nombres;
                    if (parsed.length > 1) {
                        // 範囲指定のノンブルだった場合
                        return adjuster.exec(parsed[0]) + "\u2013" + adjuster.exec(parsed.at(-1));
                    }
                    return adjuster.exec(parsed[0]);
                });
            }

            compareAddress() {
                const stack = [];
                let modified = false;
                this.originalNombres.forEach((nombre, idx) => {
                    if (Util.stripNAN(nombre) != Util.stripNAN(this.adjustedNombres[idx])) {
                        stack.push(`<span style="text-decoration: line-through;color: #35618a;">${nombre}</span><span style="color:red;">${this.adjustedNombres[idx]}</span>`);
                        modified = true;
                    }
                    else {
                        stack.push(`<span style="scolor:gray;">${nombre}</span>`);
                    }
                });
                return {
                    "modified": modified,
                    "markup": stack.join(", ")
                };
            }

        }


        document.querySelector("#exeButton").addEventListener("click", () => {
            const adjuster = new NombreAdjuster(
                document.querySelector(".config .startNombre").value,
                document.querySelector(".config .endNombre").value,
                document.querySelector(".config .nombreDelta").value
            );
            const lines = Util.getElemValueLines(".ui .inputLines");
            const output = [];
            const markups = [];
            lines.forEach(line => {
                const el = new EntryLine(line, adjuster);
                const leftSide = el.entry.name + "\u3000\u3000";
                output.push( `${leftSide}${el.adjustedNombres.join(", ")}`.trimEnd() );
                const diff = el.compareAddress();
                if (diff.modified) {
                    markups.push( "<li>" + `${leftSide}${diff.markup}`.trimEnd() + "</li>");
                }
            })
            document.querySelector(".ui textarea.result").value = output.join("\n");
            if (markups.length < 1) {
                markups.push("<div>変更箇所はありません！</div>");
            }
            document.querySelector(".result-markup").innerHTML = "<ul>" + markups.join("") + "</ul>";
        });

        document.querySelector("#copyButton").addEventListener("click", () => {
            Util.copyValue(".ui textarea.result");
        });

        document.querySelector("#printButton").addEventListener("click", () => {
            window.open('./print.html', 'newwindow', 'width=800,height=890');
        });

    </script>
</body>

</html>