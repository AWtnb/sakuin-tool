<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>ノンブル加算減算</title>
    <base target="_blank">
    <link rel="shortcut icon" href="../favicon.ico">
    <link rel="stylesheet" type="text/css" href="../style.css">
    <style>
        table.adjuster {
            margin: 0 10px;
        }
        table.adjuster {
            overflow: unset;
        }
        table.adjuster td {
            border: none;
        }
        div.msg {
            font-size: .9rem;
            font-weight: bold;
        }
        div.wrap {
            margin: .5em 0;
            line-height: 1;
            font-size: 1rem;
        }
        div.original {
            color: gray;
        }
        div.adjusted {
            color: red;
        }
        div.adjusted .same {
            color: gray;
        }
    </style>
</head>

<body>
<!-- ============================== -->
<div class="container">

<h2>ノンブル加算減算</h2>
<div class="caption">
    <ul>
        <li>名寄せされた索引に対して、指定範囲でノンブルを増やしたり減らしたりします。</li>
        <li>ノンブル間のコンマは必ず半角になります。</li>
        <li>ノンブルに数字以外が含まれていた場合は計算の対象外です。</li>
        <li>範囲を示すハイフンなどが含まれる場合もスキップします。</li>
    </ul>
</div>

<div class="ui">
    <table class="adjuster">
        <tr>
            <td>開始ノンブル</td>
            <td><input type="number" value="1" min="1" class="startNombre"></td>
        </tr>
        <tr>
            <td>終了ノンブル</td>
            <td><input type="number" value="99" min="1" class="endNombre"></td>
        </tr>
        <tr>
            <td>増分</td>
            <td><input type="number" value="1" class="nombreDelta"></td>
        </tr>
    </table>

    <div class="horizontal">
        <div class="vertical">
            <textarea id="leftTA" class="inputLines" placeholder="名寄せされた索引を貼り付けてください"></textarea>
            <input type="button" value="計算" onclick="clickBtn_adjustNombre()">
        </div>
        <div class="vertical">
            <textarea id="rightTA" class="result" placeholder="結果が表示されます" readonly></textarea>
            <input type="button" value="コピー" onclick="click_copy()">
        </div>
    </div>
    <input type="button" value="チェックリストを印刷" onclick="click_print()">
    <div id="src-detail" class="result">
    </div>
</div>

</div>
<!-- ============================== -->
<script type="text/javascript" src="../util.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/ie-buster@1.1.0/dist/ie-buster.min.js"></script>
<script>

function adjustNombre(lines, startNombre, endNombre, delta) {
    return lines.map(line => {
        if (line.replace(/\s/g, "").length < 1) {
            return {
                "original": "",
                "adjusted": "",
                "isModified": false
            }
        }
        const [item, nombre, ...rest] = line.split("　　");
        if (!nombre) {
            return {
                "original": line,
                "adjusted": line,
                "isModified": false
            }
        }
        const nombres = nombre.replace(/，/g, ",").replace(/\s/g, "").split(",").map(n => {
            if (Number(startNombre) <= Number(n) && Number(n) <= Number(endNombre)) {
                return Number(n) + Number(delta);
            }
            return n;
        });
        const adjusted = item + "　　" + nombres.join(", ");
        return {
            "original": line,
            "adjusted": adjusted,
            "isModified": (line != adjusted)
        }
    });
}

function diffNombre(origin, adjusted) {
    const nsOrigin = origin.replace(/^.+　　/, "").replace(/\s/g, "").replace(/，/g, ",").split(",");
    const nsAdjusted = adjusted.replace(/^.+　　/, "").replace(/\s/g, "").replace(/，/g, ",").split(",");
    return adjusted.replace(/　　.+$/, "") + "　　" + nsAdjusted.map((n,i) => {
        if (Number(n) == Number(nsOrigin[i])) {
            return `<span class="same">${n}</span>`;
        }
        return n;
    }).join(", ");
}


function clickBtn_adjustNombre(){
    const elem = document.querySelector(".ui");
    const adjustedArray = adjustNombre(
        multiline2array(elem.querySelector(".inputLines").value),
        elem.querySelector(".startNombre").value,
        elem.querySelector(".endNombre").value,
        elem.querySelector(".nombreDelta").value
    );
    const adjustedLines = adjustedArray.map(item => item.adjusted);
    elem.querySelector("textarea.result").value = adjustedLines.join("\r\n");
    const modified = adjustedArray.filter(item => item.isModified);
    const markup = (modified.length)?
        `<div class="msg">${modified.length}行の変更：</div>${
            modified.map(item => {
                return `<div class="wrap"><div class="original">${item.original}</div><div class="adjusted">${ diffNombre(item.original, item.adjusted) }</div></div>`;
            }).join("")
        }` : "<p>（変更箇所はありません）</p>";
    elem.querySelector("div.result").innerHTML = markup;
}

function click_copy(){
    copyValue(document.querySelector(".ui textarea.result"));
}

function click_print() {
    window.open('./print.html', 'newwindow', 'width=800,height=890');
}


const leftTA = document.getElementById("leftTA");
const rightTA = document.getElementById("rightTA");
leftTA.addEventListener("scroll", () => {
    rightTA.scrollTop = leftTA.scrollTop;
    rightTA.scrollLeft = leftTA.scrollLeft;
});
rightTA.addEventListener("scroll", () => {
    leftTA.scrollTop = rightTA.scrollTop;
    leftTA.scrollLeft = rightTA.scrollLeft;
});

</script>
</body>

</html>
