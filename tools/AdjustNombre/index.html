<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>ノンブル加算減算</title>
    <base target="_blank">
    <link rel="shortcut icon" href="../favicon.ico">
    <link rel="stylesheet" type="text/css" href="../almond.lite.css">
    <link rel="stylesheet" type="text/css" href="../additional.css">
    <style>

        div.msg {
            font-size: .9rem;
            font-weight: bold;
        }

        div.wrap {
            margin: .5em 0;
            line-height: 1;
            font-size: 1rem;
        }

        div.adjusted {
            color: #333;
        }

        div.adjusted .same {
            color: gray;
        }

        div.adjusted .mod {
            color: red;
        }

        div.adjusted .del {
            text-decoration: line-through;
            color: #35618a;
            letter-spacing: -1px;
            margin: 0;
        }

        ul.config li input {
            max-width: 20%;
        }

    </style>
</head>

<body>
    <!-- ============================== -->
    <div class="container">

        <h1>ノンブル加算減算</h1>

        <ul class="config">
            <li>
                開始
                <input type="number" value="1" min="1" class="startNombre">
            </li>
            <li>
                終了
                <input type="number" value="999" min="1" class="endNombre">
            </li>
            <li>
                増分
                <input type="number" value="1" class="nombreDelta">
            </li>
        </ul>

        <div class="ui">
            <textarea id="scrollA" class="inputLines" placeholder="paste here!"></textarea>
            <input type="button" value="計算" id="exeButton">
        </div>

        <div class="ui">
            <textarea id="scrollB" class="result" placeholder="結果が表示されます" readonly></textarea>
            <input type="button" value="コピー" id="copyButton">
        </div>

        <ul>
            <li>名寄せされた索引に対して、指定範囲でノンブルを増やしたり減らしたりします。</li>
            <li>ノンブル間のカンマは必ず半角になります。</li>
        </ul>
        <input type="button" value="チェックリストを印刷" id="printButton">
        <div id="src-detail" class="result-markup"></div>

    </div>
    <!-- ============================== -->
    <script type="module">
        import {Util, Entry, EntryAddress, setScroller, setNavi} from "../common.js";
        setScroller();
        setNavi();

        class Adjuster {
            constructor(start, end, delta) {
                this.start = start;
                this.end = end;
                this.delta = delta;
            }
            exec(target) {
                if (Number(this.start) <= target.intValue && target.intValue <= Number(this.end)) {
                    return (target.display.prefix + (target.intValue + Number(this.delta)) + target.display.suffix);
                }
                return target.display.text;
            }
        }

        function isDifferentNombres(a, b) {
            return a.join("").replace(/[^\d]/g, "") != b.join("").replace(/[^\d]/g, "");
        }

        class EntryLine {
            constructor(line, adjuster) {
                const entry = new Entry(line);
                this.name = entry.name;
                this.originalNombres = [];
                this.adjustedNombres = [];
                if (!entry.address) {
                    return
                }
                const parsedAddress = new EntryAddress(entry.address);
                this.originalNombres =parsedAddress.rawElements;
                this.adjustedNombres = this.originalNombres.map(nbr => {
                    const parsed = new EntryAddress(nbr).nombres;
                    if (parsed.length > 1) {
                        return adjuster.exec(parsed[0]) + "\u2013" + adjuster.exec(parsed.slice(-1)[0]);
                    }
                    return adjuster.exec(parsed[0]);
                });
                this.changed = isDifferentNombres(this.originalNombres, this.adjustedNombres);
            }
        }

        function adjustNombresLine(selector, start, end, delta) {
            const lines = Util.getElemValueLines(selector);
            const adjuster = new Adjuster(start, end, delta);
            return lines.map(line => new EntryLine(line, adjuster) );
        }

        function diffNombre(origin, adjusted) {
            return adjusted.map((adj, i) => {
                if (isDifferentNombres([adj], [origin[i]])) {
                    return `<span class="del">${origin[i]}</span><span class="mod">${adj}</span>`;
                }
                return `<span class="same">${adj}</span>`;
            }).join(", ");
        }


        document.querySelector("#exeButton").addEventListener("click", () => {
            const adjustedLines = adjustNombresLine(
                ".ui .inputLines",
                document.querySelector(".config .startNombre").value,
                document.querySelector(".config .endNombre").value,
                document.querySelector(".config .nombreDelta").value
            );

            document.querySelector(".ui textarea.result").value = adjustedLines.map(l => {
                if (l.name) {
                    return `${l.name}\u3000\u3000${l.adjustedNombres.join(", ")}`.trimEnd();
                }
                return "";
            }).join("\n");

            const modified = adjustedLines.filter(line => line.changed);
            const markup = [];
            if (modified.length) {
                markup.push(`<h4>${modified.length}行の変更</h4>`);
                const diffs = modified.map(item => {
                    return `<li><div class="adjusted">${item.name}\u3000\u3000${diffNombre(item.originalNombres, item.adjustedNombres)}</div></li>`;
                });
                markup.push(`<ul>${diffs.join("")}</ul>`);
            }
            else {
                markup.push("<div>（変更箇所はありません）</div>");
            }
            document.querySelector(".result-markup").innerHTML = markup.join("");
        });

        document.querySelector("#copyButton").addEventListener("click", () => {
            Util.copyValue(".ui textarea.result");
        });

        document.querySelector("#printButton").addEventListener("click", () => {
            window.open('./print.html', 'newwindow', 'width=800,height=890');
        });

    </script>
</body>

</html>