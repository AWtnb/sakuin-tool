<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>ノンブル並びの確認</title>
    <base target="_blank">
    <link rel="shortcut icon" href="../favicon.ico">
    <link rel="stylesheet" type="text/css" href="../almond.lite.css">
    <link rel="stylesheet" type="text/css" href="../additional.css">
</head>

<body>
    <!-- ============================== -->
    <div class="container">

        <h1>ノンブル並びの確認</h1>

        <div id="app">
            <div class="ui">
                <textarea placeholder="paste here!" v-model="content"></textarea>
                <button @click="check">実行</button>
            </div>

            <ul>
                <li>チェック内容：
                    <ul>
                        <li>ノンブルが正しく並んでいないもの</li>
                        <li>3つ連続しているもの</li>
                    </ul>
                </li>
                <li>カンマの全角半角は区別しません。</li>
                <li>ノンブルに半角数字以外が含まれている場合は正しく判定できません。</li>
            </ul>

            <div class="result-markup">
                <div v-if="problems.length">
                    <h3>修正の必要があります！</h3>
                    <ul>
                        <li v-for="(problem, idx) in problems" :key="idx">
                            <span>{{ problem.line }}</span><span v-for="(p, idx) in problem.detail" :key="idx">
                                <span :style="{color: p.color}">←{{ p.text }}</span>
                            </span>
                        </li>
                    </ul>
                </div>
                <div v-if="message">{{message}}</div>
            </div>
        </div>

    </div>
    <!-- ============================== -->
    <script type="module">

        import Vue from 'https://cdn.jsdelivr.net/npm/vue@2.7.4/dist/vue.esm.browser.js'

        import {Entry, EntryAddress, setNavi} from "../common.js";
        setNavi();

        class AddressChecker {
            constructor(s) {
                const entry = new Entry(s);
                this.nombres = new EntryAddress(entry.address).nombres;
                this.problems = [];
            }

            checkSort() {
                if (this.nombres.length < 2) {
                    return;
                }
                for (let i = 0; i < this.nombres.length - 1; i++) {
                    if (this.nombres[i].intValue >= this.nombres[i + 1].intValue) {
                        this.problems.push({
                            "color": "red",
                            "text": "順番！"
                        });
                    }
                }
            }

            checkHyphen() {
                if (this.nombres.length < 3) {
                    return;
                }
                for (let i = 0; i < this.nombres.length - 2; i++) {
                    const current = this.nombres[i];
                    const next1 = this.nombres[i + 1];
                    const next2 = this.nombres[i + 2];
                    if (current.intValue + 1 == next1.intValue && current.intValue + 2 == next2.intValue) {
                        if (!next1.hyphenated) {
                            this.problems.push({
                                "color": "blue",
                                "text": "連続！"
                            });
                        }
                    }
                }
            }

        }

        function grepInvalidNombreLine(lines) {
            return lines.filter(x => String(x).trim()).map(line => {
                const checker = new AddressChecker(line);
                checker.checkSort();
                checker.checkHyphen();
                if (checker.problems.length > 0) {
                    return {
                        "line": line,
                        "detail": checker.problems
                    };
                }
                return null;
            }).filter(Boolean);
        }

        const vm = new Vue({
            el: "#app",
            data: {
                content: "",
                message: "",
                problems: [],
            },
            computed: {
                contentLines: function() {
                    return this.content.split(/\n/).map(line => String(line));
                },
            },
            methods: {
                reset: function() {
                    this.message = "";
                    this.problems = [];
                },
                check: function(){
                    this.reset();
                    grepInvalidNombreLine(this.contentLines).forEach(x => {
                        this.problems.push(x);
                    });
                    if(!this.problems.length) {
                        this.message = "問題は見当たりません！";
                    }
                }
            }
        });

    </script>
</body>

</html>