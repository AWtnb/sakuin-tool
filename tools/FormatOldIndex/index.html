<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>旧版索引の事前整形</title>
    <base target="_blank">
    <link rel="shortcut icon" href="../favicon.ico">
    <link rel="stylesheet" type="text/css" href="../style.css">
    <style>
    </style>
</head>

<body>
<!-- ============================== -->
<div class="container">

<h2>旧版索引の事前整形</h2>
<div class="caption">
    <ul>
        <li>項目とノンブルの間を2倍アキに統一します。</li>
        <li>連続するノンブルを示すダーシの種類を統一します。</li>
        <li>子項目のダーシの種類を統一します。</li>
    </ul>
</div>

<div class="ui">
    <div class="horizontal">
        <div class="vertical">
            <textarea class="inputLines" placeholder="旧版索引から抽出した索引をコピー＆ペーストしてください"></textarea>
            <input type="button" value="整形" onclick="click_format()">
        </div>
        <div class="vertical">
            <textarea class="result" placeholder="結果が表示されます" readonly></textarea>
            <input type="button" value="コピー" onclick="click_copy()">
        </div>
    </div>
</div>

</div>
<!-- ============================== -->
<script type="text/javascript" src="../util.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/ie-buster@1.1.0/dist/ie-buster.min.js"></script>
<script>

function formatSepartor(s) {
    const f = s.replace(/　/g, "　　").replace(/　+/g, "　　").replace(/　　→/, "　→").replace(/　　(?!\d)/g, "");
    if (s.startsWith("　")) {
        return `　${f}`;
    }
    return f;
}

function formatNombre(s) {
    return s.replace(/，/g, ",").replace(/[\u2010\u2011\u2012\u2013\u2014\u2015\uFF0D]+/g, "-");
}

function formatChild(s) {
    return "　" + s.trim().replace(/^[\u2010\u2011\u2012\u2013\u2014\u2015\uFF0D]+|[\u2010\u2011\u2012\u2013\u2014\u2015\uFF0D]+$/, "――");
}

function formatLines(lines) {
    return lines.map(line => line.replace(/ /g, "")).map(line => formatSepartor(line)).map(line => {
        if (line.indexOf("　　") != -1) {
            const [item, nombre, ...rest] = line.split("　　");
            const fmt = (item.startsWith("　"))? formatChild(item) : item;
            return `${fmt}　　${formatNombre(nombre)}`;
        }
        return line;
    });
}

function click_format() {
    const elem = document.querySelector(".ui");
    const lines = multiline2array(elem.querySelector(".inputLines").value);
    elem.querySelector(".result").value = formatLines(lines).join("\n");
}

function click_copy() {
    copyValue(document.querySelector(".ui .result"));
}

</script>
</body>

</html>
