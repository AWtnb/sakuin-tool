<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>旧版索引の事前整形</title>
    <base target="_blank">
    <link rel="shortcut icon" href="../favicon.ico">
    <link rel="stylesheet" type="text/css" href="../style.css">
    <style>
        .pair {
            word-break: break-all;
            font-size: .8em;
            margin: .5em 0;
            line-height: 1;
            border-left: 2px solid #ccc;
            padding: 2px;
        }

        .origin {
            color: gray;
        }

        .modified {
            color: red;
        }

        .msg {
            font-weight: bold;
        }
    </style>
</head>

<body>
    <!-- ============================== -->
    <div class="container">
        <div class="navi"><a href="../../index.html">TOP</a></div>

        <h2>旧版索引の事前整形</h2>
        <div class="caption">
            <ul>
                <li>項目とノンブルの間を2倍アキに統一します。</li>
                <li>連続するノンブルを示すダーシの種類を統一します。</li>
                <li>子項目のダーシの種類を統一します。</li>
            </ul>
        </div>

        <div class="ui">
            <div class="horizontal">
                <div class="vertical">
                    <textarea id="leftTA" class="inputLines" placeholder="paste here!"></textarea>
                    <input type="button" value="整形" id="exeButton">
                </div>
                <div class="vertical">
                    <textarea id="rightTA" class="result" placeholder="結果が表示されます" readonly></textarea>
                    <input type="button" value="コピー" id="copyButton">
                </div>
            </div>
            <div class="diff"></div>
        </div>

    </div>
    <!-- ============================== -->
    <script type="text/javascript" src="../common.js" defer></script>
    <script>

        class IndexLine {

            static bars = ["\u2010", "\u2011", "\u2012", "\u2013", "\u2014", "\u2015", "\uFF0D", "\u2500", "\u002d"];
            static barsPattern = `[${IndexLine.bars.join("")}]`;

            constructor(s) {
                this.text = String(s);
            }

            formatSpace() {
                const origin = this.text;
                this.text = this.text.replace(/\u3000/g, "\u3000\u3000").replace(/\u3000+/g, "\u3000\u3000"); // 全部2倍アキに
                this.text = this.text.replace(/\u3000\u3000→/g, "\u3000→"); // 矢印の前は1倍アキに
                this.text = this.text.replace(/(?<=.{2,})\u3000\u3000(?!\d)/, "\u3000"); // 項目3文字目以降にあるアキは1倍（例：イドラッ　蘇倶　　12）
                this.text = this.text.replace(/\u3000\u3000(?!\d)/g, ""); // 残っている2倍アキは不要
                if (origin.startsWith("\u3000")) {
                    this.text = `\u3000${this.text}`;
                }
                else {
                    this.text = this.text;
                }
            }

            formatConnector() {
                const reg = new RegExp(`${IndexLine.barsPattern}+`, "g");
                this.text = this.text.replace(reg, "\u2013");
            }

            executeFormat() {
                this.formatSpace();
                this.formatConnector();
                const entry = new Entry(this.text);
                if (entry.name && entry.address) {
                    const reg = new RegExp(IndexLine.barsPattern);
                    if (entry.isChild || entry.name.match(reg)) {
                        return IndexLine.formatChild(entry.name) + "\u3000\u3000" + entry.address;
                    }
                    return entry.name.trim() + "\u3000\u3000" + entry.address;
                }
                return this.text;
            }

            static formatChild(s) {
                const reg = new RegExp(`^${IndexLine.barsPattern}+|${IndexLine.barsPattern}+$`);
                return "\u3000" + s.trim().replace(reg, "――");
            }

        }

        function formatOldIndex(selector) {
            const lines = Util.getElemValueLines(selector);
            return lines.map(line => String(line).trimEnd().replace(/\t/, "　　")).map(line => {
                const fmt = new IndexLine(line).executeFormat();
                return {
                    "Line": fmt,
                    "Origin": line,
                    "Modified": (fmt != line)
                };
            });
        }

        document.querySelector("#exeButton").addEventListener("click", () => {
            const elem = document.querySelector(".ui");
            const formatted = formatOldIndex(".ui .inputLines");
            elem.querySelector(".result").value = formatted.map(x => x.Line).join("\n");

            const output = elem.querySelector(".diff");
            output.innerHTML = "";
            const diff = formatted.filter(x => x.Modified)
            if (diff.length) {
                output.innerHTML = `<div class="msg">${diff.length}箇所を修正しました：</msg>` + diff.map(d => {
                    return `<div class="pair"><div class="origin">${d.Origin}</div><div class="modified">${d.Line}</div></div>`;
                }).join("");
            }
        });

        document.querySelector("#copyButton").addEventListener("click", () => {
            Util.copyValue(document.querySelector(".ui .result"));
        });

        const leftTA = document.getElementById("leftTA");
        const rightTA = document.getElementById("rightTA");
        leftTA.addEventListener("scroll", () => {
            rightTA.scrollTop = leftTA.scrollTop;
            rightTA.scrollLeft = leftTA.scrollLeft;
        });
        rightTA.addEventListener("scroll", () => {
            leftTA.scrollTop = rightTA.scrollTop;
            leftTA.scrollLeft = rightTA.scrollLeft;
        });

    </script>
</body>

</html>